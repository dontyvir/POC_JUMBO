<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap 
   PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
   "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap >
	<resultMap id="resultCBarra" class="java.util.HashMap">
		<result property="key" column="row_id"/>
		<result property="valor" column="col2"/>
		<result property="estado" column="estado"/>
	</resultMap>
	
	<select id="getCBarra" resultMap="resultCBarra" >
	<![CDATA[
		SELECT PRD.PRO_ID||'-'||CBARRA.ID_PRODUCTO||'-'||CBARRA.COD_BARRA_BIGINT AS row_id,
			PRD.PRO_ID||'|'||CBARRA.COD_BARRA_BIGINT||'|'||CBARRA.COD_BARRA||'|'||TIP_CODBAR AS col2,
			'N' AS ESTADO
		FROM BODBA.BO_CODBARRA CBARRA
		JOIN BODBA.BO_PRODUCTOS BPRO ON BPRO.ID_PRODUCTO = CBARRA.ID_PRODUCTO AND (CBARRA.COD_BARRA is not null and CBARRA.COD_BARRA_BIGINT is not null )    
		JOIN FODBA.FO_PRODUCTOS PRD ON  PRD.PRO_ID_BO = BPRO.ID_PRODUCTO AND PRD.PRO_ESTADO = 'A'  
		WHERE PRD.PRO_ID in (SELECT DISTINCT PRC.PRE_PRO_ID FROM FODBA.FO_PRECIOS_LOCALES AS PRC, BODBA.BO_LOCALES AS LOC 
             				WHERE PRC.PRE_LOC_ID = LOC.ID_LOCAL AND PRC.PRE_ESTADO = 'A' AND PRC.PRE_TIENESTOCK = 1)
	]]>
	</select>
	<select id="getCBarraNov" resultMap="resultCBarra" >
	<![CDATA[
	WITH DATOS
	(
        ID_DAT_CBARRA,
	    COL2
	)
	AS
	(
		SELECT PRD.PRO_ID||'-'||CBARRA.ID_PRODUCTO||'-'||CBARRA.COD_BARRA_BIGINT AS ID_DAT_CBARRA,
			PRD.PRO_ID||'|'||CBARRA.COD_BARRA_BIGINT||'|'||CBARRA.COD_BARRA||'|'||TIP_CODBAR  AS col2
		FROM BODBA.BO_CODBARRA CBARRA
			JOIN BODBA.BO_PRODUCTOS BPRO ON BPRO.ID_PRODUCTO = CBARRA.ID_PRODUCTO AND (CBARRA.COD_BARRA is not null and CBARRA.COD_BARRA_BIGINT is not null )    
			JOIN FODBA.FO_PRODUCTOS PRD ON  PRD.PRO_ID_BO = BPRO.ID_PRODUCTO AND PRD.PRO_ESTADO = 'A'  
			WHERE PRD.PRO_ID in (SELECT DISTINCT PRC.PRE_PRO_ID FROM FODBA.FO_PRECIOS_LOCALES AS PRC, BODBA.BO_LOCALES AS LOC 
             						WHERE PRC.PRE_LOC_ID = LOC.ID_LOCAL AND PRC.PRE_ESTADO = 'A' AND PRC.PRE_TIENESTOCK = 1)
    )
    
	SELECT PRE.ROW_ID,
		   PRE.COL2,
		   PRE.ESTADO
	  FROM (
	    /* MODIFICADOS */
	    SELECT DATOS.ID_DAT_CBARRA AS ROW_ID, DATOS.COL2, 'M' AS ESTADO
	      FROM DATOS, bodba.BO_INT_CBARRA AS DIS
	     WHERE DIS.ID_INT_CBARRA = DATOS.ID_DAT_CBARRA
	       AND DIS.INT_DATA != DATOS.COL2
	       
	     UNION ALL
	     /* NUEVOS */
        SELECT D.ID_DAT_CBARRA AS ROW_ID, D.COL2, 'N' AS ESTADO
	    FROM DATOS D LEFT JOIN bodba.BO_INT_CBARRA AS CBARRA on D.ID_DAT_CBARRA=CBARRA.ID_INT_CBARRA WHERE CBARRA.ID_INT_CBARRA is null  
                    
	     UNION ALL
	     /* ELIMINADOS */
	    SELECT DIS.ID_INT_CBARRA AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
	      FROM bodba.BO_INT_CBARRA AS DIS	      
	     WHERE NOT EXISTS (SELECT 1 FROM DATOS AS DAT JOIN bodba.BO_INT_CBARRA AS CB ON DAT.ID_DAT_CBARRA = CB.ID_INT_CBARRA)
        UNION ALL
	     /* ELIMINADOS cuando no viene en la estructura datos*/	    	
		    SELECT DIS.ID_INT_CBARRA AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
		    FROM bodba.BO_INT_CBARRA AS DIS LEFT JOIN DATOS D on DIS.ID_INT_CBARRA = D.ID_DAT_CBARRA  WHERE D.ID_DAT_CBARRA is null
	     ) AS PRE
	]]>
	</select>
</sqlMap>