<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap 
   PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
   "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap >
	<resultMap id="resultOffer" class="java.util.HashMap">
		<result property="key" column="row_id"/>
		<result property="valor" column="col2"/>
		<result property="estado" column="estado"/>
	</resultMap>
	<select id="getOffers" resultMap="resultOffer">
	<![CDATA[
		     SELECT DISTINCT 
               CAST(PRM.ID_PROMOCION AS VARCHAR(50)) AS row_id,
               PRM.TIPO_PROMO||'|'||
               VARCHAR_FORMAT(PRM.FINI,'DD-MM-YYYY HH24:MI:SS')||'|'|| 
               VARCHAR_FORMAT(PRM.FFIN,'DD-MM-YYYY HH24:MI:SS')||'|'||
               TRIM(REPLACE(NVL(PRM.DESCR,'-'),'|',''))||'|'|| 
               TRIM(REPLACE(NVL(PRM.BANNER,'-'),'|',''))||'|'||
               PRM.ID_PROMOCION||'|'||
               DECODE(PRM.TIPO_PROMO,3,PRM.CANT_MIN,12,PRM.CANT_MIN,CAST(PRM.BENEFICIO1 AS INT))||'|'||
               DECODE(PRM.TIPO_PROMO,3,CAST(PRM.BENEFICIO1 AS INT), 12,CAST(PRM.BENEFICIO1 AS INT), CAST(PRM.BENEFICIO2 AS INT))||'|'||
               DECODE(PRM.TIPO_PROMO,3,CAST(PRM.BENEFICIO2 AS INT), 12,CAST(PRM.BENEFICIO2 AS INT),  CAST(PRM.BENEFICIO3 AS INT)) AS col2,
               'N' AS ESTADO
          FROM BODBA.PR_PROMOCION PRM,
               (
                SELECT DISTINCT COD_PROMO
                FROM (
                	SELECT DISTINCT PPR.COD_PROMO1 AS COD_PROMO
					FROM BODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN FODBA.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO1 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
				UNION ALL
					SELECT DISTINCT PPR.COD_PROMO2 AS COD_PROMO
					FROM FODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN fodba.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO2 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN fodba.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
				UNION ALL
					SELECT DISTINCT PPR.COD_PROMO3 AS COD_PROMO
					FROM FODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN fodba.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO3 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN fodba.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
                )
               ) AS PROMO
         WHERE PRM.COD_PROMO = PROMO.COD_PROMO 
         AND PRM.TIPO_PROMO IN (1,2,3,4,11,12,100,105,200,205) AND
         CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN
    ]]>
	</select>
	<select id="getOffersMatch" resultMap="resultOffer">
	<![CDATA[
			SELECT PRM.ID_PROMOCION||'-'||PROMO.ID_PRODUCTO_FO||'-'||PRM.ID_LOCAL AS row_id,
       		   PRM.ID_PROMOCION||'|'||PROMO.ID_PRODUCTO_FO||'|'||PRM.ID_LOCAL AS col2,
       		   'N' AS ESTADO
		  FROM BODBA.PR_PROMOCION PRM,
		       (
                    SELECT DISTINCT COD_PROMO, ID_PRODUCTO_FO, ID_LOCAL
                    FROM (
                        SELECT DISTINCT  PPR.COD_PROMO1 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO1 AND PPR.COD_PROMO1 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    UNION ALL
                        SELECT DISTINCT  PPR.COD_PROMO2 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO2 AND PPR.COD_PROMO2 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    UNION ALL
                        SELECT DISTINCT  PPR.COD_PROMO3 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO3 AND PPR.COD_PROMO3 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    ) ORDER BY ID_PRODUCTO_FO
               ) AS PROMO
		 WHERE PRM.COD_PROMO = PROMO.COD_PROMO
        AND PRM.ID_LOCAL = PROMO.ID_LOCAL
        AND PRM.TIPO_PROMO IN (1,2,3,4,11,12,100,105,200,205)
		AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN
        ORDER BY PROMO.ID_PRODUCTO_FO		
    ]]>
	</select>
	<select id="getOffersNov" resultMap="resultOffer">
	<![CDATA[
		WITH DATOS
		(
		    ID_DAT_PROMOCION,
		    COL2
		)
		AS
		(
         SELECT DISTINCT 
               CAST(PRM.ID_PROMOCION AS VARCHAR(50)) AS ID_DAT_PROMOCION,
               PRM.TIPO_PROMO||'|'||
               VARCHAR_FORMAT(PRM.FINI,'DD-MM-YYYY HH24:MI:SS')||'|'|| 
               VARCHAR_FORMAT(PRM.FFIN,'DD-MM-YYYY HH24:MI:SS')||'|'||
               TRIM(REPLACE(NVL(PRM.DESCR,'-'),'|',''))||'|'|| 
               TRIM(REPLACE(NVL(PRM.BANNER,'-'),'|',''))||'|'||
               PRM.ID_PROMOCION||'|'||
               DECODE(PRM.TIPO_PROMO,3,PRM.CANT_MIN,12,PRM.CANT_MIN,CAST(PRM.BENEFICIO1 AS INT))||'|'||
               DECODE(PRM.TIPO_PROMO,3,CAST(PRM.BENEFICIO1 AS INT), 12,CAST(PRM.BENEFICIO1 AS INT), CAST(PRM.BENEFICIO2 AS INT))||'|'||
               DECODE(PRM.TIPO_PROMO,3,CAST(PRM.BENEFICIO2 AS INT), 12,CAST(PRM.BENEFICIO2 AS INT),  CAST(PRM.BENEFICIO3 AS INT)) AS col2
          FROM BODBA.PR_PROMOCION PRM,
               (
                SELECT DISTINCT COD_PROMO
                FROM (
                	SELECT DISTINCT PPR.COD_PROMO1 AS COD_PROMO
					FROM BODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN FODBA.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO1 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
				UNION ALL
					SELECT DISTINCT PPR.COD_PROMO2 AS COD_PROMO
					FROM FODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN fodba.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO2 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN fodba.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
				UNION ALL
					SELECT DISTINCT PPR.COD_PROMO3 AS COD_PROMO
					FROM FODBA.PR_PRODUCTO_PROMOS PPR 
					JOIN fodba.FO_PRODUCTOS AS PRD ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PPR.COD_PROMO3 != 0 AND PRD.PRO_ESTADO = 'A')
					JOIN fodba.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' AND PRE.PRE_TIENESTOCK=1)
                )
               ) AS PROMO
         WHERE PRM.COD_PROMO = PROMO.COD_PROMO 
         AND PRM.TIPO_PROMO IN (1,2,3,4,11,12,100,105,200,205) AND
         CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN
    	)

	  SELECT PRE.ROW_ID, PRE.COL2, PRE.ESTADO
	  FROM (
	    /* MODIFICADOS */
        SELECT DATOS.ID_DAT_PROMOCION AS ROW_ID, DATOS.COL2, 'M' AS ESTADO
        FROM DATOS, BODBA.BO_INT_PROMOCION AS DIS
        WHERE DIS.ID_INT_PROMOCION = DATOS.ID_DAT_PROMOCION
        AND DIS.INT_DATA != DATOS.COL2
	    
        UNION ALL
	     /* NUEVOS */	      
	    SELECT D.ID_DAT_PROMOCION AS ROW_ID, D.COL2, 'N' AS ESTADO
	    FROM DATOS D LEFT JOIN BODBA.BO_INT_PROMOCION AS PMC on D.ID_DAT_PROMOCION=PMC.ID_INT_PROMOCION WHERE PMC.ID_INT_PROMOCION is null 

	     UNION ALL
	     /* ELIMINADOS */
	    SELECT DIS.ID_INT_PROMOCION AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
	      FROM BODBA.BO_INT_PROMOCION AS DIS
	     WHERE NOT EXISTS (SELECT 1 FROM DATOS AS DAT  JOIN BODBA.BO_INT_PROMOCION AS PMC ON PMC.ID_INT_PROMOCION = DAT.ID_DAT_PROMOCION)
	     
	     UNION ALL
	     /* ELIMINADOS cuando no viene en la estructura datos*/	    	
		    SELECT DIS.ID_INT_PROMOCION AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
		    FROM bodba.BO_INT_PROMOCION AS DIS LEFT JOIN DATOS D on DIS.ID_INT_PROMOCION = D.ID_DAT_PROMOCION WHERE D.ID_DAT_PROMOCION is null
		    
        ) AS PRE
    ]]>
	</select>
	<select id="getOffersMatchNov" resultMap="resultOffer">
	<![CDATA[
	WITH DATOS
	(
	    ID_DAT_PROMOCION_MATCH,
	    COL2
	)
	AS
	(
		SELECT PRM.ID_PROMOCION||'-'||PROMO.ID_PRODUCTO_FO||'-'||PRM.ID_LOCAL AS ID_DAT_PROMOCION_MATCH,
       		   PRM.ID_PROMOCION||'|'||PROMO.ID_PRODUCTO_FO||'|'||PRM.ID_LOCAL AS col2
       		   
		  FROM BODBA.PR_PROMOCION PRM,
		       (
                    SELECT DISTINCT COD_PROMO, ID_PRODUCTO_FO, ID_LOCAL
                    FROM (
                        SELECT DISTINCT  PPR.COD_PROMO1 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO1 AND PPR.COD_PROMO1 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    UNION ALL
                        SELECT DISTINCT  PPR.COD_PROMO2 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO2 AND PPR.COD_PROMO2 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    UNION ALL
                        SELECT DISTINCT  PPR.COD_PROMO3 AS COD_PROMO, PRD.PRO_ID AS ID_PRODUCTO_FO, PPR.ID_LOCAL AS ID_LOCAL
                        FROM BODBA.PR_PROMOCION AS PRM 
                        JOIN BODBA.PR_PRODUCTO_PROMOS AS PPR ON (PRM.COD_PROMO = PPR.COD_PROMO3 AND PPR.COD_PROMO3 != 0 AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN)
                        JOIN FODBA.FO_PRODUCTOS AS PRD  ON (PPR.ID_PRODUCTO = PRD.PRO_ID_BO AND PRD.PRO_ESTADO = 'A')
                        JOIN FODBA.FO_PRECIOS_LOCALES AS PRE ON (PRE.PRE_PRO_ID = PRD.PRO_ID AND PRE.PRE_ESTADO = 'A' and PRE.PRE_TIENESTOCK=1)
                    ) ORDER BY ID_PRODUCTO_FO
               ) AS PROMO
		WHERE PRM.COD_PROMO = PROMO.COD_PROMO
        AND PRM.ID_LOCAL = PROMO.ID_LOCAL
        AND PRM.TIPO_PROMO IN (1,2,3,4,11,12,100,105,200,205)
		AND CURRENT TIMESTAMP BETWEEN PRM.FINI AND PRM.FFIN
        ORDER BY PROMO.ID_PRODUCTO_FO
    ) 
	SELECT PRE.ROW_ID, PRE.COL2,  PRE.ESTADO
	  FROM (
	    /* MODIFICADOS */
	    SELECT DATOS.ID_DAT_PROMOCION_MATCH AS ROW_ID, DATOS.COL2, 'M' AS ESTADO
	      FROM DATOS, BODBA.BO_INT_PROMOCION_MATCH AS DIS
	     WHERE DIS.ID_INT_PROMOCION_MATCH = DATOS.ID_DAT_PROMOCION_MATCH
	       AND DIS.INT_DATA != DATOS.COL2
	       
	     UNION ALL
	     /* NUEVOS */
	    SELECT D.ID_DAT_PROMOCION_MATCH AS ROW_ID, D.COL2, 'N' AS ESTADO
	    FROM DATOS D LEFT JOIN BODBA.BO_INT_PROMOCION_MATCH AS PRM on D.ID_DAT_PROMOCION_MATCH=PRM.ID_INT_PROMOCION_MATCH WHERE PRM.ID_INT_PROMOCION_MATCH is null    
	       	           
	     UNION ALL
	     
	     /* ELIMINADOS */
	    SELECT DIS.ID_INT_PROMOCION_MATCH AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
	      FROM BODBA.BO_INT_PROMOCION_MATCH AS DIS
	     WHERE NOT EXISTS 
	           (SELECT 1 FROM DATOS AS DAT JOIN BODBA.BO_INT_PROMOCION_MATCH AS PRM ON PRM.ID_INT_PROMOCION_MATCH = DAT.ID_DAT_PROMOCION_MATCH)
	           
	     UNION ALL
	     /* ELIMINADOS cuando no viene en la estructura datos*/	    	
		    SELECT DIS.ID_INT_PROMOCION_MATCH AS ROW_ID, DIS.INT_DATA AS COL2, 'E' AS ESTADO
		    FROM bodba.BO_INT_PROMOCION_MATCH AS DIS LEFT JOIN DATOS D on DIS.ID_INT_PROMOCION_MATCH = D.ID_DAT_PROMOCION_MATCH WHERE D.ID_DAT_PROMOCION_MATCH is null
		    
        ) AS PRE
    ]]>
	</select>
</sqlMap>